<?xml version="1.0" encoding="UTF-8"?>
<wdkModel name="toyModel">

    <!-- ******************* -->
    <!-- model introduction  -->
    <!-- ******************* -->
    <introduction>
        Welcome to WDKToySite, a sample website driven by the GUS Web Development Kit.
        You are invited to explore this site to find out about the core functionalities of WDK.
        Enjoy the surfing!
    </introduction>


    <!-- ************ -->
    <!-- questionSets -->
    <!-- ************ -->
    
    <!-- 
    A question is "a query that returns a list of records."  (Regular queries 
    return columns and rows.)  They are formed by pairing a query with a
    record class.  The query must be one that returns one column containing
    a list of primary keys.  The record class must be one that expects as
    a primary key the type of key returned by the query.
    
    A question set is a grouping of questions.  It may be used in the
    user interface to present the enclosed questions in one choice box.  
    -->


    <!-- questions that return RNA records -->
    <questionSet name="RnaQuestions"
                 displayName="Queries to find RNAs">

        <description>
          These queries find RNAs
        </description>

        <question name="ByDbESTLib" 
                  queryRef="RnaIds.ByDbESTLib" 
                  recordClassRef="RnaRecordClasses.RnaRecordClass"/>


        <question name="ByNumSeqs" 
                  queryRef="RnaIds.ByNumSeqs" 
                  recordClassRef="RnaRecordClasses.RnaRecordClass"/>

    </questionSet>


    <!-- *************** -->
    <!-- recordClassSets -->
    <!-- *************** -->

    <!-- 
    A "record" is an object that gathers together data about an entity in the
    database.  The entity is defined as data associated with a primary key, 
    and data in the record is based on that key. The data comes in three forms:
    attributes, text attributes and tables.  An attribute is a single value
    that describes the entity, such as "size."  A text attribute is similar,
    but the value is created by defining a text string and optionally embedding
    into that string the values of other attributes.  A table is a value
    in the form of columns and rows, such as a table describing related 
    publications.
  
    A record class is a template for creating records from a given primary key.
    It includes "attribute queries," "table queries" and "text attributes."  

    An attribute query must have only one parameter, the primary key.  It must
    return exactly zero or one rows.  The columns in the query are interpreted
    as attributes of the record.  

    A text attribute has a body of text with the values of other attributes
    optionally embedded in it.  The other attribute values are referred to
    as variables of the form "$$name_of_attribute$$".

    A table query must have only one parameter, the primary key.  It may
    return any number of rows (but typically not a huge number).  The result
    of the query is interpreted as being a table that 
    
    A "record set" is a grouping of records. It is useful in organizing the
    model xml file.

    The full name of a record is is of the form "set_name.name."
    --> 

    <!-- RNA recordClasses -->
    <recordClassSet name="RnaRecordClasses">

        <recordClass idPrefix="DT." name="RnaRecordClass" type="DoTS Transcript">
            <attributeQueryRef ref="RnaAttributes.GeneAttrs"/>  
            <attributeQueryRef ref="RnaAttributes.AssemblyAttrs"/>

            <tableQueryRef ref="RnaTables.ConstituentEsts"/>

            <textAttribute name="overview">
                <text>
                    This is DoTS Transcript DT.$$primaryKey$$.  It is from $$taxon_name$$.
                </text>
            </textAttribute>
        </recordClass>
    </recordClassSet>


    <!-- *************** -->
    <!-- model querySets -->
    <!-- *************** -->

    <!--
    A "query" obtains tabular values from a data source.  It has columns
    and parameters.  So far, only SQL data sources are supported, but others,
    such as flat files are coming.  

    Queries are used for different purposes: providing primary keys to a 
    question; providing attributes and tables to a record; and, providing
    vocabularies to vocabulary parameters.

    A "query set" is a grouping of queries.  It is useful in organizing the
    model xml file.  

    The full name of a query is of the form "set_name.name."
    -->


    <!-- Queries that return RNA primary keys (for use in questions). -->

    <querySet name="RnaIds">

        <sqlQuery name="ByDbESTLib" displayName="RNAs by number of EST libs">
            <description>
                Find RNAs from a given organism and contain ESTs from more than a specified number of libraries.
            </description>

            <paramRef ref="params.NumEstLibs"/>
            <paramRef ref="params.ApiTaxon"/>
            <column name="na_sequence_id"/>
            <sql>
                <!-- use CDATA because query includes angle brackets -->
                <![CDATA[
                    select distinct aseq.assembly_na_sequence_id as na_sequence_id 
                    from WDKTestEst est, WDKTestLibrary lib,
                         WDKTestAssemblySequence aseq, WDKTestAssembly a
                    where lib.library_id = est.library_id 
                    and est.na_sequence_id = aseq.na_sequence_id 
                    and aseq.assembly_na_sequence_id = a.na_sequence_id
                    and aseq.assembly_na_sequence_id is not NULL 
                    and a.taxon_id in ($$ApiTaxon$$)
                    group by aseq.assembly_na_sequence_id 
                    having count (distinct lib.dbest_id) >= $$NumEstLibs$$
                ]]>
            </sql>
        </sqlQuery>


        <sqlQuery name="ByNumSeqs" displayName="RNAs by number of assembled seqs">
            <description>
                Find RNAs from a given organism that contain more than a 
                specified number of ESTs in their assembly.
            </description>
            <paramRef ref="params.NumSeqs"/>
            <paramRef ref="params.ApiTaxon"/>
            <column name="na_sequence_id"/>
            <sql>
                <!-- use CDATA because query includes angle brackets -->
                <![CDATA[
                    select distinct a.na_sequence_id
                    from WDKTestAssembly a
                    where a.number_of_contained_sequences > $$NumSeqs$$
                    and a.taxon_id in ($$ApiTaxon$$)
                ]]>
            </sql>
        </sqlQuery>        
    </querySet>


    <!-- Queries that retrieve attributes of RNAs -->
    
    <querySet name="RnaAttributes">

        <sqlQuery name="GeneAttrs">
            <paramRef ref="params.primaryKey"/>
            <column displayName="RNA Id" name="primary_key"/>
            <column displayName="Organism" name="taxon_name"/>
            <sql>
                select a.na_sequence_id as primary_key,
                       tn.name as taxon_name
                from WDKTestAssembly a, WDKTestTaxonName tn
                where a.na_sequence_id = $$primaryKey$$ and a.taxon_id = tn.taxon_id
            </sql>
        </sqlQuery>


        <sqlQuery name="AssemblyAttrs">
            <paramRef ref="params.primaryKey"/>
            <column displayName="Assembly consistency" name="assembly_consistency"/>
            <column displayName="Contains mRNA" name="contains_mrna"/>
            <column displayName="Number contained sequences" name="number_of_contained_sequences"/>
            <textColumn displayName="Nice Num" name="numseqs" text="number of contained seqs is $$number_of_contained_sequences$$"/>
            <sql>
                select a.assembly_consistency, 
                       a.contains_mrna,
                       a.number_of_contained_sequences
                from WDKTestAssembly a, WDKTestTaxonName tn 
                where a.na_sequence_id = $$primaryKey$$ 
                and a.taxon_id = tn.taxon_id 
            </sql>
        </sqlQuery>
    </querySet>


    <!-- Queries that retrieve tables belonging to RNAs  -->
    
    <querySet name="RnaTables">
        <sqlQuery name="ConstituentEsts">
            <paramRef ref="params.primaryKey"/>
                <column displayName="EST Id" name="na_sequence_id"/>
                <column displayName="Assembly Sequence Id" name="assembly_sequence_id"/>
                <column displayName="Sequence Start" name="sequence_start"/>
                <column displayName="Sequence End" name="sequence_end"/>
                <column displayName="Quality Start" name="quality_start"/>
                <column displayName="Quality End" name="quality_end"/>
            <sql>
                select aseq.na_sequence_id, aseq.assembly_sequence_id, aseq.sequence_start,
                       aseq.sequence_end, aseq.quality_start, aseq.quality_end
                from WDKTestAssemblySequence aseq, WDKTestAssembly a
                where a.na_sequence_id = $$primaryKey$$
                and a.na_sequence_id = aseq.assembly_na_sequence_id
            </sql>
        </sqlQuery>
    </querySet>
    


    <!-- queries that return controlled vocabulary terms -->

    <querySet name="VocabQueries">
        <!-- a query that returns a list of Apicomplexon taxons -->
        <sqlQuery name="ApiTaxon">
            <column name="term"/>
            <column name="internal"/>
            <sql>
                select distinct name as term, taxon_id as internal
                from WDKTestTaxonName
                where name in ('Neospora caninum', 'Plasmodium falciparum', 'Eimeria tenella',
                               'Plasmodium yoelii', 'Sarcocystis neurona', 'Toxoplasma gondii')
            </sql>
        </sqlQuery>
    </querySet>



    <!-- parameters used by queries -->

    <paramSet name="params">

        <stringParam name="primaryKey" 
                     prompt="Primary Key" 
                     help="primary key" />

        <stringParam name="NumSeqs" 
                     prompt="Number of Contained Sequences" 
                     help="number of seqs" 
                     regex="\d+"/>

        <stringParam name="NumEstLibs" 
                     prompt="Number of EST Libs" 
                     help="number of distinct libs" 
                     sample="3"/>

        <flatVocabParam name="ApiTaxon" 
                        prompt="Organism" 
                        help="Apicomplexon taxons" 
                        multipick="yes"
                        queryRef="VocabQueries.ApiTaxon"/>
    </paramSet>

</wdkModel>
